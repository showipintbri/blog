<!DOCTYPE html><html><head><head> <!-- Include Meta Tags Here --><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="viewport" content="width=device-width, height=device-height, initial-scale=1 user-scalable=no, shrink-to-fit=no"><meta content='#000000' name='theme-color'/><meta name="keywords" content="Blog, CCIE, Cisco, Wireshark, PCAP, Suricata, Bro, Zeek"><title>Failing Forward | Today I Was Asked... Episode 1</title><!-- Open Graph general (Facebook, Pinterest & Google+) --><meta name="og:title" content="Failing Forward | Today I Was Asked... Episode 1"><meta name="og:description" content="Today I was asked "When a Cisco ASA throws a '500003' syslog message, was the packet forwarded or dropped?""><meta name="og:image" content="/assets/images/posts/2021-02-02-tiwa-ep1/title.png"><meta name="og:image:alt" content="Failing Forward | Today I Was Asked... Episode 1"><meta name="og:url" content="https://blog.showipintbri.com/blog/tiwa-ep1"><meta name="article:author" content="https://www.facebook.com/"><meta name="og:site_name" content="Failing Forward | Today I Was Asked... Episode 1"><meta name="og:type" content="website"> <!-- Twitter --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Failing Forward | Today I Was Asked... Episode 1"><meta name="twitter:description" content="Today I was asked "When a Cisco ASA throws a '500003' syslog message, was the packet forwarded or dropped?""><meta name="twitter:site" content="@showipintbri"><meta name="twitter:creator" content="@showipintbri"><meta name="twitter:image" content="https://blog.showipintbri.com/assets/images/posts/2021-02-02-tiwa-ep1/title.png"> <!-- Search Engine --><meta name="description" content="Today I was asked "When a Cisco ASA throws a '500003' syslog message, was the packet forwarded or dropped?""><meta name="image" content="/assets/images/posts/2021-02-02-tiwa-ep1/title.png"> <!-- Schema.org for Google --><meta itemprop="name" content="Failing Forward | Today I Was Asked... Episode 1"><meta name="author" content="Tony E."/><meta itemprop="description" content="Today I was asked "When a Cisco ASA throws a '500003' syslog message, was the packet forwarded or dropped?""><meta itemprop="image" content="/assets/images/posts/2021-02-02-tiwa-ep1/title.png"><title>Failing Forward</title><link rel="stylesheet" href="/assets/css/style.css"> <script src="https://kit.fontawesome.com/6a97161b76.js" crossorigin="anonymous"></script><link rel="shortcut icon" href="https://blog.showipintbri.com/assets/images/logo.png" type="image/x-icon"></head></head><body><nav class="navbar is-black is-fixed-top" role="navigation" aria-label="main navigation" id="navbar"><div class="container"> <!-- logo or branding image on left side --><div class="navbar-brand"> <a class="navbar-item" href="https://blog.showipintbri.com/"> <strong>Failing Forward</strong> </a><div class="navbar-burger" data-target="navbar-menu"> <span></span> <span></span> <span></span></div></div><!-- children of navbar-menu must be navbar-start and/or navbar-end --><div class="navbar-menu has-background-black" id="navbar-menu"> <!-- navbar items | left side --> <!--<div class="navbar-start"></div>--> <!-- navbar items | right side --><div class="navbar-end"> <a class="navbar-item " href="https://blog.showipintbri.com/">HOME</a> <a class="navbar-item" href="https://blog.showipintbri.com/#about">ABOUT</a> <a class="navbar-item" href="https://blog.showipintbri.com/#contact">CONTACT</a><div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link"> BLOG </a><div class="navbar-dropdown has-background-black is-left"> <a href="https://blog.showipintbri.com/blog" class="navbar-item has-text-grey-light "> BLOG POSTS </a> <a href="https://blog.showipintbri.com/tags" class="navbar-item has-text-grey-light "> TAGS </a> <!-- <a href="https://blog.showipintbri.com/categories" class="navbar-item has-text-grey-light "> CATEGORIES </a> <a href="https://blog.showipintbri.com/search" class="navbar-item has-text-grey-light "> SEARCH </a> --></div></div></div></div></div></nav><!-- Bulma Navbar JS --> <script> document.addEventListener('DOMContentLoaded', function () { /* Get all "navbar-burger" elements */ var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0); /* Check if there are any navbar burgers */ if ($navbarBurgers.length > 0) { /* Add a click event on each of them */ $navbarBurgers.forEach(function ($el) { $el.addEventListener('click', function () { /* Get the target from the "data-target" attribute */ var target = $el.dataset.target; var $target = document.getElementById(target); /* Toggle the class on both the "navbar-burger" and the "navbar-menu" */ $el.classList.toggle('is-active'); $target.classList.toggle('is-active'); }); }); } }); </script><section class="hero is-fullheight has-text-centered" id="post"><div class="hero-body"><div class="container"> <a href="/blog/tiwa-ep1" class="has-text-black" id="title"><h1 class="title has-text-centered is-2 has-text-weight-semibold ">Today I Was Asked... Episode 1</h1></a><hr class="has-background-black"><div class="columns is-variable is-5"><div class="column is-6"><figure class="image is-16by9 has-shadow"> <img src="/assets/images/posts/2021-02-02-tiwa-ep1/title.png" alt="" id="post-image"></figure></div><div class="subtitle column is-5 has-text-left-desktop has-text-left-fullhd has-text-left-tablet has-text-center-mobile"><p id="description" class="content is-small has-text-weight-medium is-uppercase">Today I was asked "When a Cisco ASA throws a '500003' syslog message, was the packet forwarded or dropped?"</p><p class="subtitle is-6 is-uppercase has-text-weight-normal has-text-black-ter">Published on <b>February 02, 2021</b> by <a href="https://twitter.com/showipintbri" target="_blank"><b class="has-text-link"><u>Tony E.</u></b> </a></p><p class="subtitle is-uppercase"> <i class="fas fa-tags"></i> <a href="/blog/tag/t-i-w-a"><span class="tag is-link">t.i.w.a</span></a> <a href="/blog/tag/cisco-asa"><span class="tag is-link">cisco asa</span></a> <a href="/blog/tag/scapy"><span class="tag is-link">scapy</span></a></p><p class="subtitle is-uppercase"><i class="fas fa-clock"></i> <b class="has-text-link"> 13 min </b>READ</p></div></div><div class="content has-text-left-desktop has-text-left-fullhd has-text-left has-text-left-tablet has-text-left-mobile"><p><h1 id="today-i-was-asked">Today I Was Asked:</h1><blockquote><h3 id="when-a-cisco-asa-throws-a-500003-syslog-message-was-the-packet-forwarded-or-dropped">“When a Cisco ASA throws a ‘500003’ syslog message, was the packet forwarded or dropped?”</h3></blockquote><p>For today’s TIWA I wasn’t sure of the answer. I needed to do some research.</p><p>I built a lab, looked at PCAPs and studied the documentation. Here’s what I found.</p><h4 id="what-is-syslog-message-500003">What is syslog message 500003?</h4><p>Cisco Reference: <a href="https://www.cisco.com/c/en/us/td/docs/security/asa/syslog/b_syslog/syslogs5.html#con_4773942">https://www.cisco.com/c/en/us/td/docs/security/asa/syslog/b_syslog/syslogs5.html#con_4773942</a></p><p align="center"> <a href="https://www.cisco.com/c/en/us/td/docs/security/asa/syslog/b_syslog/syslogs5.html#con_4773942"><img src="/assets/images/posts/2021-02-02-tiwa-ep1/cisco-syslog.png" /></a></p><p>In Cisco’s explanation of the error message it isn’t clear on whether or not the packet was forwarded or dropped after the syslog message was thrown. I found myself needing to answer some questions:</p><ul><li>I could just assume that a packet with an INVALID TCP header would be dropped but, how could I <em>prove</em> it?</li><li>What evidence would I need to gather to <em>prove</em> it was dropped or forwarded?</li><li>What would I need to do/build to test this out?</li><li>What if this was a clever evasion strategy from a nation state threat actor and someone was leaning on me to positively say “dropped” or “forwarded”?</li></ul><p align="center"> <img src="/assets/images/posts/2021-02-02-tiwa-ep1/meme.png" /></p><p>…this was something I just couldn’t let go. I needed to know the answer.</p><p>The <a href="https://www.cisco.com/c/en/us/td/docs/security/asa/syslog/b_syslog/syslogs5.html#con_4773942">Cisco documentation</a> provided some clues:</p><ul><li>TCP RST while responding to a connection request [TCP SYN] to a disabled socket</li><li>Some operating systems send incorrect TCP header lengths</li><li>TCP header length may indicate it is larger than the packet length</li></ul><p>Inside the TCP header is a field that, when multiplied by 4, gives the length of the TCP headerin bytes. This is called the “Data Offset” becasue it’s the measurement of bytes between the end of the Layer-3 header and the start of the payload.</p><p>Reference: RFC 793: <a href="https://tools.ietf.org/html/rfc793#section-3.1">https://tools.ietf.org/html/rfc793#section-3.1</a></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Data Offset:  4 bits

    The number of 32 bit words in the TCP Header.  This indicates where
    the data begins.  The TCP header (even one including options) is an
    integral number of 32 bits long.
</code></pre></div></div><p align="center"> <img src="/assets/images/posts/2021-02-02-tiwa-ep1/tcp-header-rfc.png" /></p><p>By default the TCP header is 20-bytes. Therefore, the TCP header length field would be “0x5” (as mentioned above, the header length value is multiplied by 4).</p><p>This field is interesting because it is only 4-bits long which means it can only hold decimal values of “0” thru “15”. These values multiplied by 4 are: 0,4,8,12,16,20,24,28,32,36,40,44,48,52,56 &amp; 60. In this list only values greater than or equal to “20” are valid. This also means that we could have a TCP header that is 60 bytes in length according to the possible field values.</p><h3 id="question-what-would-happen-if-we-artificially-inflated-or-deflated-that-value-when-the-actual-tcp-header-remains-20-bytes-long">Question: What would happen if we artificially inflated or deflated that value, when the actual TCP header remains 20-bytes long?</h3><blockquote><p>“When in doubt, lab it out!” - Tony E.</p></blockquote><p><strong>Experiment #1: Incorrect TCP Header length in the SYN packet.</strong></p><p>Iterate through the possible TCP Header length values (0 - 15) sending one packet each from the client to the server.</p><ul><li>Capture the packets leaving the Client.</li><li>Observe the syslog messages from the ASA (if there are any)</li><li>Does the ASA forward these packets to the server?</li><li>Capture incoming packets on the server to verify their reciept.</li></ul><p><strong>Experiment #2: Incorrect TCP Header length in the RST packet.</strong></p><p>From the Client, initiate a valid TCP SYN through the ASA toward the Server. On the Server use scapy to craft automatic reponses. Respond to the TCP SYN with an ACK/RST. Iterate through the 16 possible TCP Header length values.</p><ul><li>Capture the packets leaving the Client.</li><li>Capture incoming packets on the server to verify their reciept.</li><li>Capture the return packet (ACK/RST) from the Server.</li><li>Observe the syslog messages from the ASA (if there are any)</li><li>Does the ASA forward these packets to the Client?</li><li>Capture packets on the Client to verify whether ot not the packets are received.</li></ul><p align="center"> <img src="/assets/images/posts/2021-02-02-tiwa-ep1/topology.png" /></p><p>In both experiments the client is a Windows 10, Surface Pro 5 and the server is an Ubuntu 16.04 VM running in VMware ESXi.</p><h2 id="experiment-1-incorrect-tcp-header-length-in-the-syn-packet">Experiment #1: Incorrect TCP Header length in the SYN packet.</h2><p>Using <a href="https://github.com/showipintbri/documentation/blob/main/scapy/readme.md">scapy</a>, I sent TCP-SYN’s from the “inside” through the “outside” of the ASA to a closed socket on a server. I sent the TCP-SYN starting with a TCP Header length field of “0” and increased by “1” for each subsequent TCP-SYN.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Malformed TCP Header (Incorrect Offset/Header Length)
</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s">"192.168.1.251"</span><span class="p">)</span><span class="o">/</span><span class="n">TCP</span><span class="p">(</span><span class="n">sport</span><span class="o">=</span><span class="mi">666</span><span class="p">,</span><span class="n">dport</span><span class="o">=</span><span class="mi">777</span><span class="p">,</span><span class="n">dataofs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="s">"S"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</code></pre></div></div><p>Wireshark calls this field the “TCP Header”, other references call it the “Data Offset”. This is a 4-bit field and so can only contain the decimal values between 0-15. To compute the offset or header length in bytes this value is multiplied by 4.</p><ul><li>Data Offset value of 0 means 0 bytes of Offset becasue 0 x 4 = 0.</li><li>Data Offset value of 5 means 20 bytes of Offset becasue 5 x 4 = 20. (This is the default TCP header length without any TCP Options.)</li><li>Data Offset value of 8 means 32 bytes of Offset becasue 8 x 4 = 32.</li></ul><p>If you set the Offset value to anything less than “5” Wireshark will tell you: <code class="language-plaintext highlighter-rouge">Expert Info (Error/Protocol): Bogus TCP header length (0, must be at least 20)</code></p><p align="center"> <img src="/assets/images/posts/2021-02-02-tiwa-ep1/wireshark_exp_1.png" /></p><p><strong>NOTE:</strong> These are NOT TCP Retransmissions. They are labelled that way by Wireshark because the reuse of the <code class="language-plaintext highlighter-rouge">ip.id</code> field.</p><p>By capturing at the source and the destination you can see the only <strong>TCP SYN</strong> to get through the ASA has a valid header length value of 0x5 or 20-bytes. Because our server wasn’t listening on the destination port, the server responded with a TCP-RST, terminating the connection. The logs from the Cisco ASA corroborate the packet capture.</p><h4 id="experiment-1-cisco-asa-logs">Experiment #1: Cisco ASA Logs</h4><p>The below logs indicate the error was thrown by “from 10.123.123.101” (our client) as the source. Also you’ll notice no error when the header length equals 20 “(hdrlen=20…”. This is becasue our packets had a TCP header length of 20, this was a valid packet and didn’t generate an error.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%ASA-5-500003: Bad TCP hdr length (hdrlen=0, pktlen=58) from 10.123.123.101/0 to 192.168.1.251/0, flags: INVALID, on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=4, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: INVALID, on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=8, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: INVALID, on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=12, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: INVALID, on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=16, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside

%ASA-5-500003: Bad TCP hdr length (hdrlen=24, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=28, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=32, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=36, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=40, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=44, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=48, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=52, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=56, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
%ASA-5-500003: Bad TCP hdr length (hdrlen=60, pktlen=58) from 10.123.123.101/666 to 192.168.1.251/777, flags: SYN , on interface inside
</code></pre></div></div><p>This was a good test. It validates my testing architecture, scripts and environment are working as designed. Now, to being answering the question we’re here for…</p><h2 id="experiment-2-incorrect-tcp-header-length-in-the-rst-packet">Experiment #2: Incorrect TCP Header length in the RST packet.</h2><p>This time we will send valid TCP-SYN’s from the client through the ASA to the Server and on the server we will respond with TCP-RST with incorrect TCP header lengths. Again, I will use <a href="https://github.com/showipintbri/documentation/blob/main/scapy/readme.md">scapy</a> to send the SYN from the client but this time we’ll also use scapy on the server to create an answering machine which automatically responds with a TCP ACK/RST using data offset values we define.</p><h4 id="scapy-answering-machine-with-incorrect-tcp-header-length">Scapy Answering Machine With Incorrect TCP Header Length</h4><p>Reference: <a href="https://stackoverflow.com/questions/24415464/scapy-sending-receiving-and-responding">https://stackoverflow.com/questions/24415464/scapy-sending-receiving-and-responding</a></p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">rst</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="n">IP</span><span class="p">].</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="n">IP</span><span class="p">].</span><span class="n">src</span><span class="p">)</span><span class="o">/</span><span class="n">TCP</span><span class="p">(</span>
        <span class="n">flags</span><span class="o">=</span><span class="s">'RA'</span><span class="p">,</span>
        <span class="n">sport</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="n">TCP</span><span class="p">].</span><span class="n">dport</span><span class="p">,</span>
        <span class="n">dport</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="n">TCP</span><span class="p">].</span><span class="n">sport</span><span class="p">,</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">ack</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">TCP</span><span class="p">].</span><span class="n">seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">dataofs</span><span class="o">=</span><span class="mi">8</span>
    <span class="p">)</span>
    <span class="n">send</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"%s</span><span class="se">\n</span><span class="s"> =&gt; %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">IP</span><span class="p">].</span><span class="n">summary</span><span class="p">(),</span> <span class="n">ans</span><span class="p">.</span><span class="n">summary</span><span class="p">())</span>
    
<span class="n">sniff</span><span class="p">(</span><span class="n">iface</span><span class="o">=</span><span class="s">"eth0"</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s">"tcp and tcp[tcpflags] &amp; tcp-syn == tcp-syn"</span><span class="p">,</span><span class="n">prn</span><span class="o">=</span><span class="n">rst</span><span class="p">)</span>
</code></pre></div></div><h4 id="experiment-2-client-side-pcap">Experiment #2: Client side PCAP</h4><p>In this PCAP you can see the client sending 16 TCP-SYN packets with valid header lengths. The Client only recieves 1 reply from the server.</p><p align="center"> <img src="/assets/images/posts/2021-02-02-tiwa-ep1/wireshark_exp_2_client.png" /></p><p><strong>NOTE:</strong> These are NOT TCP Retransmissions. They are labelled that way by Wireshark because the reuse of the <code class="language-plaintext highlighter-rouge">ip.id</code> field.</p><h4 id="experiment-2-server-side-pcap">Experiment #2: Server side PCAP</h4><p>In this server side PCAP you can see the server does respond to every request received from the client and responds with an invalid or malformed TCP ACK/RST. Again, I started at value of “0” and increased by 1 for every iteration.</p><p align="center"> <img src="/assets/images/posts/2021-02-02-tiwa-ep1/wireshark_exp_2_server.png" /></p><p><strong>NOTE:</strong> These are NOT TCP Retransmissions. They are labelled that way by Wireshark because the reuse of the <code class="language-plaintext highlighter-rouge">ip.id</code> field.</p><h4 id="experiment-2-cisco-asa-logs">Experiment #2: Cisco ASA Logs</h4><p>The below Cisco ASA logs would corroborate what we are seeing from the packet captures. This time the errors are thrown specifiying “from 192.168.1.251” (the server) as the source. You don’t see an error message for “(hdrlen=20…” becasue our headers were 20 bytes and they were valid.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%ASA-5-500003: Bad TCP hdr length (hdrlen=0, pktlen=58) from 192.168.1.251/0 to 10.123.123.101/0, flags: INVALID, on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=4, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: INVALID, on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=8, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: INVALID, on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=12, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: INVALID, on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=16, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside

%ASA-5-500003: Bad TCP hdr length (hdrlen=24, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=28, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=32, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=36, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=40, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=44, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=48, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=52, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=56, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
%ASA-5-500003: Bad TCP hdr length (hdrlen=60, pktlen=58) from 192.168.1.251/777 to 10.123.123.101/666, flags: RST ACK , on interface outside
</code></pre></div></div><h2 id="conclusion">Conclusion</h2><h4 id="question">Question:</h4><blockquote><p>When a Cisco ASA throws a “500003” syslog message, was the packet forwarded or dropped?</p></blockquote><h4 id="answer">Answer:</h4><p>From my analysis, in my testing environment, I observed the Cisco ASA 5505 running code “ASA Version 9.2(4)” dropped packets with incorrect TCP header lengths whether the value was under or above the actual TCP header length. This causes the ASA to throw an error message: <code class="language-plaintext highlighter-rouge">%ASA-5-500003</code> and drop the packet.</p><h4 id="appendix-cisco-asa-baseline-config-for-reference">Appendix: Cisco ASA Baseline Config for Reference</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ciscoasa# sho run
: Saved
:
: Serial Number: 
: Hardware:   ASA5505, 512 MB RAM, CPU Geode 500 MHz
:
ASA Version 9.2(4)
!
hostname ciscoasa
enable password 8Ry2YjIyt7RRXU24 encrypted
xlate per-session deny tcp any4 any4
xlate per-session deny tcp any4 any6
xlate per-session deny tcp any6 any4
xlate per-session deny tcp any6 any6
xlate per-session deny udp any4 any4 eq domain
xlate per-session deny udp any4 any6 eq domain
xlate per-session deny udp any6 any4 eq domain
xlate per-session deny udp any6 any6 eq domain
passwd 2KFQnbNIdI.2KYOU encrypted
names
!
interface Ethernet0/0
 switchport access vlan 5
!
interface Ethernet0/1
 switchport access vlan 10

[ ... omitted for brevity ... ]

interface Vlan5
 nameif outside
 security-level 0
 ip address dhcp setroute
!
interface Vlan10
 nameif inside
 security-level 100
 ip address 10.123.123.1 255.255.255.0
!
boot system disk0:/asa924-k8.bin
ftp mode passive
pager lines 24
logging enable
logging console notifications
logging monitor notifications
logging buffered informational
mtu outside 1500
mtu inside 1500
icmp unreachable rate-limit 1 burst-size 1
no asdm history enable
arp timeout 14400
no arp permit-nonconnected
timeout xlate 3:00:00
timeout pat-xlate 0:00:30
timeout conn 1:00:00 half-closed 0:10:00 udp 0:02:00 icmp 0:00:02
timeout sunrpc 0:10:00 h323 0:05:00 h225 1:00:00 mgcp 0:05:00 mgcp-pat 0:05:00
timeout sip 0:30:00 sip_media 0:02:00 sip-invite 0:03:00 sip-disconnect 0:02:00
timeout sip-provisional-media 0:02:00 uauth 0:05:00 absolute
timeout tcp-proxy-reassembly 0:01:00
timeout floating-conn 0:00:00
dynamic-access-policy-record DfltAccessPolicy
user-identity default-domain LOCAL
no snmp-server location
no snmp-server contact
crypto ipsec security-association pmtu-aging infinite
crypto ca trustpool policy
telnet timeout 5
ssh stricthostkeycheck
ssh timeout 5
ssh key-exchange group dh-group1-sha1
console timeout 0

dhcpd address 10.123.123.100-10.123.123.150 inside
dhcpd enable inside
!
threat-detection basic-threat
threat-detection statistics access-list
no threat-detection statistics tcp-intercept
!
class-map inspection_default
 match default-inspection-traffic
!
!
policy-map global_policy
 class inspection_default
  inspect icmp
!
service-policy global_policy global
prompt hostname context
no call-home reporting anonymous
Cryptochecksum:7ee497ef016ac635c23ce2bd9980ee74
: end
</code></pre></div></div></p></div></div></div></section><footer id="footer"> <!--Footer Button--><div class="container has-text-centered has-background-grey-darker" id="backtotop"> <a class="has-text-white" onclick="window.scroll(0,0)">BACK TO TOP</a></div><!--Footer Main Section--><div class="has-background-grey-darker"><div class="container columns"> <!--Name Section--><div class="column has-text-left-desktop has-text-centered-mobile"> <a href="https://blog.showipintbri.com/#about"><div class="columns"><div class="column is-one-fifth-desktop is-one-fifth-fullhd is-one-quarter-tablet"><figure class="image is-64x64"> <img class="is-rounded" src="/assets/images/tonye.jpg"></figure></div><div class="column is-marginless"><h5 class="has-text-grey-lighter">Tony E.</h5><div class="content has-text-grey"><p>Tony E. is a network security engineer, CCIE# 64908 & GIAC: Network Fore...</p></div></div></div></a></div><!--Link Section--><div class="column has-text-white"><h3>More Links</h3><!--<li> <a href="https://blog.showipintbri.com/blog/tag/certifications">certifications</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/cisco-asa">cisco asa</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/eve-ng">eve-ng</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/future">future</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/giac">giac</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/goals">goals</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/google-cloud">google cloud</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/gparted">gparted</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/hex">hex</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/internet-access">internet access</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/intrusion-prevention">intrusion prevention</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/ips">ips</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/live">live</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/network-collective">network collective</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/network-field-day">network field day</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/network-forensics">network forensics</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/nfd23">nfd23</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/organization">organization</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/partitions">partitions</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/past">past</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/pcap">pcap</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/present">present</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/sans">sans</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/scapy">scapy</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/scripts">scripts</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/sharkfest">sharkfest</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/stream">stream</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/surface-pro">surface pro</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/suricata">suricata</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/t-i-w-a">t.i.w.a</a></li><li> <a href="https://blog.showipintbri.com/tags">Tags</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/tcp">tcp</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/tcpdump">tcpdump</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/tracewrangler">tracewrangler</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/vyos">vyos</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/wireshark">wireshark</a></li><li> <a href="https://blog.showipintbri.com/blog/tag/zeek">zeek</a></li>--><li> <a target="_blank" href="https://blog.showipintbri.com/feed.xml">Subscribe via RSS</a></li></div><!--Blog-post Section--><div class="column has-text-white"><h3>Recent Posts</h3><li> <a href="https://blog.showipintbri.com/blog/where-to-start">Where To Start Capturing Packets</a></li><li> <a href="https://blog.showipintbri.com/blog/docker-wsl2">Docker on WSL2</a></li><li> <a href="https://blog.showipintbri.com/blog/sharkfest-2021">WiresharkFest 2021 (US)</a></li></div></div></div><div class="has-background-black has-text-centered has-text-white" id="credits"> <i class="far fa-copyright"></i> 2022 | Based on <a href="https://github.com/thedevslot/WhatATheme" target="_blank" rel="noopener noreferrer">WhatATheme</a> Powered by <a href="https://jekyllrb.com/" target="_blank">Jekyll</a></div></footer></body></html>

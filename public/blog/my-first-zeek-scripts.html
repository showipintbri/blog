<!DOCTYPE html><html><head><head> <!-- Include Meta Tags Here --><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="viewport" content="width=device-width, height=device-height, initial-scale=1 user-scalable=no, shrink-to-fit=no"><meta content='#000000' name='theme-color'/><meta name="keywords" content="Blog, CCIE, Cisco, Wireshark, PCAP, Suricata, Bro, Zeek"><title>Failing Forward | My First 2 Zeek Scripts</title><!-- Open Graph general (Facebook, Pinterest & Google+) --><meta name="og:title" content="Failing Forward | My First 2 Zeek Scripts"><meta name="og:description" content="I wrote my first two Zeek scripts to solve a simple problem of logging every UDP packet."><meta name="og:image" content="/assets/images/posts/2021-04-09-first-zeek-scripts/zeek_scripts.png"><meta name="og:image:alt" content="Failing Forward | My First 2 Zeek Scripts"><meta name="og:url" content="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/my-first-zeek-scripts"><meta name="article:author" content="https://www.facebook.com/NetCollectivePC"><meta name="og:site_name" content="Failing Forward | My First 2 Zeek Scripts"><meta name="og:type" content="website"> <!-- Twitter --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Failing Forward | My First 2 Zeek Scripts"><meta name="twitter:description" content="I wrote my first two Zeek scripts to solve a simple problem of logging every UDP packet."><meta name="twitter:site" content="@showipintbri"><meta name="twitter:creator" content="@showipintbri"><meta name="twitter:image" content="https://blog.showipintbri.com/assets/images/posts/2021-04-09-first-zeek-scripts/zeek_scripts.png"> <!-- Search Engine --><meta name="description" content="I wrote my first two Zeek scripts to solve a simple problem of logging every UDP packet."><meta name="image" content="/assets/images/posts/2021-04-09-first-zeek-scripts/zeek_scripts.png"> <!-- Schema.org for Google --><meta itemprop="name" content="Failing Forward | My First 2 Zeek Scripts"><meta name="author" content="Tony E."/><meta itemprop="description" content="I wrote my first two Zeek scripts to solve a simple problem of logging every UDP packet."><meta itemprop="image" content="/assets/images/posts/2021-04-09-first-zeek-scripts/zeek_scripts.png"><title>Failing Forward</title><link rel="stylesheet" href="/pages/showipintbri/blog-source/assets/css/style.css"> <script src="https://kit.fontawesome.com/6a97161b76.js" crossorigin="anonymous"></script><link rel="shortcut icon" href="https://blog.showipintbri.com/pages/showipintbri/blog-source/assets/images/logo.png" type="image/x-icon"></head></head><body><nav class="navbar is-black is-fixed-top" role="navigation" aria-label="main navigation" id="navbar"><div class="container"> <!-- logo or branding image on left side --><div class="navbar-brand"> <a class="navbar-item" href="https://blog.showipintbri.com/pages/showipintbri/blog-source/"> <strong>Failing Forward</strong> </a><div class="navbar-burger" data-target="navbar-menu"> <span></span> <span></span> <span></span></div></div><!-- children of navbar-menu must be navbar-start and/or navbar-end --><div class="navbar-menu has-background-black" id="navbar-menu"> <!-- navbar items | left side --> <!--<div class="navbar-start"></div>--> <!-- navbar items | right side --><div class="navbar-end"> <a class="navbar-item " href="https://blog.showipintbri.com/pages/showipintbri/blog-source/">HOME</a> <a class="navbar-item" href="https://blog.showipintbri.com/pages/showipintbri/blog-source/#about">ABOUT</a> <a class="navbar-item" href="https://blog.showipintbri.com/pages/showipintbri/blog-source/#contact">CONTACT</a><div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link"> BLOG </a><div class="navbar-dropdown has-background-black is-left"> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog" class="navbar-item has-text-grey-light "> BLOG POSTS </a> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/tags" class="navbar-item has-text-grey-light "> TAGS </a> <!-- <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/categories" class="navbar-item has-text-grey-light "> CATEGORIES </a> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/search" class="navbar-item has-text-grey-light "> SEARCH </a> --></div></div></div></div></div></nav><!-- Bulma Navbar JS --> <script> document.addEventListener('DOMContentLoaded', function () { /* Get all "navbar-burger" elements */ var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0); /* Check if there are any navbar burgers */ if ($navbarBurgers.length > 0) { /* Add a click event on each of them */ $navbarBurgers.forEach(function ($el) { $el.addEventListener('click', function () { /* Get the target from the "data-target" attribute */ var target = $el.dataset.target; var $target = document.getElementById(target); /* Toggle the class on both the "navbar-burger" and the "navbar-menu" */ $el.classList.toggle('is-active'); $target.classList.toggle('is-active'); }); }); } }); </script><section class="hero is-fullheight has-text-centered" id="post"><div class="hero-body"><div class="container"> <a href="/pages/showipintbri/blog-source/blog/my-first-zeek-scripts" class="has-text-black" id="title"><h1 class="title has-text-centered is-2 has-text-weight-semibold ">My First 2 Zeek Scripts</h1></a><hr class="has-background-black"><div class="columns is-variable is-5"><div class="column is-6"><figure class="image is-16by9 has-shadow"> <img src="/assets/images/posts/2021-04-09-first-zeek-scripts/zeek_scripts.png" alt="" id="post-image"></figure></div><div class="subtitle column is-5 has-text-left-desktop has-text-left-fullhd has-text-left-tablet has-text-center-mobile"><p id="description" class="content is-small has-text-weight-medium is-uppercase">I wrote my first two Zeek scripts to solve a simple problem of logging every UDP packet.</p><p class="subtitle is-6 is-uppercase has-text-weight-normal has-text-black-ter">Published on <b>April 09, 2021</b> by <a href="https://twitter.com/showipintbri" target="_blank"><b class="has-text-link"><u>Tony E.</u></b> </a></p><p class="subtitle is-uppercase"> <i class="fas fa-tags"></i> <a href="/blog/tag/zeek"><span class="tag is-link">zeek</span></a> <a href="/blog/tag/scripts"><span class="tag is-link">scripts</span></a> <a href="/blog/tag/pcap"><span class="tag is-link">pcap</span></a></p><p class="subtitle is-uppercase"><i class="fas fa-clock"></i> <b class="has-text-link"> 4 min </b>READ</p></div></div><div class="content has-text-left-desktop has-text-left-fullhd has-text-left has-text-left-tablet has-text-left-mobile"><p><p><strong>tl;dr</strong> This blog post was for documentation purposes. Nothing to see here.</p><h2 id="problem-statement">Problem Statement:</h2><blockquote><p>I need to have Zeek log every UDP packet instead of only per UDP session/conversation</p></blockquote><p>Because of Zeek’s session tracking it will only log one connection “uid” at the start of a session and for all subsequent packets which are part of the same session or conversation.</p><p>For example, using the popular <a href="http://tcpreplay.appneta.com/wiki/captures.html#smallflows-pcap">smallFlows.pcap</a> you can see there are <em>501</em> UDP packets:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># tcpdump

tcpdump -nr smallFlows.pcap udp | wc -l
501

# Wireshark Display Filter:
udp &amp;&amp; !icmp
^^^ This count is 501 packets

# NOTE: You have to exclude 'icmp' because the Type-11's and Type-3's re-encapsulate the original UDP packet.
# You can identify these packets using the filter 'udp &amp;&amp; icmp'(&lt;-- this count is 22 packets).
# Using just 'udp' filter will result in also counting the icmp ecapsulated udp packets (&lt;-- this count is 523)
</code></pre></div></div><p /><p>Using Zeek on the same PCAP and filtering the logs showing only protocol UDP yields a much lower count:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zeek -C -r smallFlows.pcap
grep udp conn.log | wc -l
173
</code></pre></div></div><p /><p>So, where did all the other packets go? The packets are there but Zeek only creates a new log entry for every unique session. Packets that are part of the same flow or conversation are counted together. In fact if you use the below command and add up all the numbers in the 6th and 7th columns you’ll get 501:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat conn.log | /opt/zeek/bin/zeek-cut id.orig_h id.orig_p id.resp_h id.resp_p proto orig_pkts resp_pkts uid | grep udp
</code></pre></div></div><p>NOTE: The 6th and 7th columns are the number of packets seen with the <strong>Orig</strong>inator as the <em>source</em> or the <strong>Resp</strong>onder as the <em>source</em> (on a per-packet analysis)</p><h2 id="how-do-we-get-zeek-to-log-each-udp-packet-instead-of-each-session-or-conversation">How do we get Zeek to log each UDP packet instead of each session or conversation?</h2><p>I’m glad you asked, I wrote a script for that!</p><p>This first script simply logs to STDOUT for every UDP request or UDP reply and logs them as individual unique connections.</p><h4 id="script-1-udp_scriptzeek">Script #1: udp_script.zeek</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>event udp_request(u: connection){
# Choose one format to un-comment
#	print fmt("UDP Request: %s", u$id);
#	print fmt("%s UDP Request: %s %s --&gt; %s %s", u$uid, u$id$orig_h, u$id$orig_p, u$id$resp_h, u$id$resp_p);
	print fmt("UDP Request: %s %s --&gt; %s %s", u$id$orig_h, u$id$orig_p, u$id$resp_h, u$id$resp_p);
}

event udp_reply(u: connection){
# Choose the matching format from above to un-comment
#	print fmt("UDP Reply  : %s", u$id);
#	print fmt("%s UDP Reply  : %s %s &lt;-- %s %s", u$uid, u$id$orig_h, u$id$orig_p, u$id$resp_h, u$id$resp_p);
	print fmt("UDP Reply  : %s %s &lt;-- %s %s", u$id$orig_h, u$id$orig_p, u$id$resp_h, u$id$resp_p);
}
</code></pre></div></div><p /><p>Lets run this script against our PCAP file:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># NOTE: I'm in the same directory as my pcap and my script file. The Zeek binary is in its default location.

sudo /opt/zeek/bin/zeek -C -r smallFlows.pcap udp_script.zeek

UDP Request: 192.168.3.131 57757/udp --&gt; 239.255.255.250 1900/udp
UDP Request: 192.168.3.131 57757/udp --&gt; 239.255.255.250 1900/udp
UDP Request: 192.168.3.131 57757/udp --&gt; 239.255.255.250 1900/udp
UDP Request: 192.168.3.131 57757/udp --&gt; 239.255.255.250 1900/udp
UDP Request: 192.168.3.131 57757/udp --&gt; 239.255.255.250 1900/udp
UDP Request: 192.168.3.131 57757/udp --&gt; 239.255.255.250 1900/udp
UDP Request: 192.168.3.131 68/udp --&gt; 255.255.255.255 67/udp
UDP Request: 192.168.3.131 54600/udp --&gt; 224.0.0.252 5355/udp
UDP Request: 192.168.3.131 54600/udp --&gt; 224.0.0.252 5355/udp
UDP Request: 172.16.255.1 50983/udp --&gt; 71.224.25.112 33695/udp
[ ... OMITTED FOR BREVITY ... ]
</code></pre></div></div><p /><p>Sweet, now lets make sure we have the same number of log lines as we do UDP packets in the PCAP:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo /opt/zeek/bin/zeek -C -r smallFlows.pcap udp_script.zeek | wc -l
501
</code></pre></div></div><p /><p>Awsome! While this is great and proof that we are generating logs the way we intended. It isn’t actaully logging anywhere and the results aren’t being picked up by other tools (Filebeat–&gt;Logstash–&gt;Elastic&lt;–Kibana).</p><h2 id="leverage-the-zeek-logging-framework">Leverage the Zeek Logging Framework</h2><p>This script will generate a Zeek log file “udp_packets.log” with the columns: Timestamp, UID, Source IP, SRC Port, Destination IP, Dest Port</p><h4 id="script-2-udp_logzeek">Script #2: udp_log.zeek</h4><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module Udplog;

export {
	redef enum Log::ID += { LOG };

	type Info: record {
		ts: time	&amp;log;
		uid: string	&amp;log;
		id: conn_id	&amp;log;
	};
}

event zeek_init(){
	Log::create_stream(Udplog::LOG, [$columns=Info, $path="udp_packets"]);
}

event udp_request(u: connection){
	local rec: Udplog::Info = [$ts=network_time(), $uid=u$uid, $id=u$id];
	Log::write(Udplog::LOG, rec);
}

event udp_reply(u: connection){
	local rec: Udplog::Info = [$ts=network_time(), $uid=u$uid, $id=u$id];
	Log::write(Udplog::LOG, rec);
}

</code></pre></div></div><p /><p>Running this against the same PCAP, Zeek will create a new log file: udp_packets.log. Zeeks standard log file format includes 8 lines of metadata pre-pended and 1 line appended.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wc -l udp_packets.log
510

# NOTE: Subtracting the 9 lines of metadata leave 501 lines of logs.
</code></pre></div></div><p /><p>Using <code class="language-plaintext highlighter-rouge">zeek-cut</code> can clean-up the log for you:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat udp_packets.log | /opt/zeek/bin/zeek-cut | wc -l
501

^^^ BOOM !
</code></pre></div></div><p /><p>You do not need to run both of these scripts together at the same time. The first script was a proof of concept and prints to STDOUT while the second is a more permanent script to be used during live capture and when ingesting your logs into other tools. You can also send output as JSON if needed.</p><p>Thanks for reading.</p></p></div></div></div></section><footer id="footer"> <!--Footer Button--><div class="container has-text-centered has-background-grey-darker" id="backtotop"> <a class="has-text-white" onclick="window.scroll(0,0)">BACK TO TOP</a></div><!--Footer Main Section--><div class="has-background-grey-darker"><div class="container columns"> <!--Name Section--><div class="column has-text-left-desktop has-text-centered-mobile"> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/#about"><div class="columns"><div class="column is-one-fifth-desktop is-one-fifth-fullhd is-one-quarter-tablet"><figure class="image is-64x64"> <img class="is-rounded" src="/assets/images/tonye.jpg"></figure></div><div class="column is-marginless"><h5 class="has-text-grey-lighter">Tony E.</h5><div class="content has-text-grey"><p>Tony E. is a network security engineer, CCIE# 64908 & GIAC: Network Fore...</p></div></div></div></a></div><!--Link Section--><div class="column has-text-white"><h3>More Links</h3><!--<li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/certifications">certifications</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/cisco-asa">cisco asa</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/eve-ng">eve-ng</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/future">future</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/giac">giac</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/goals">goals</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/google-cloud">google cloud</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/gparted">gparted</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/hex">hex</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/internet-access">internet access</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/intrusion-prevention">intrusion prevention</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/ips">ips</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/live">live</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/network-collective">network collective</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/network-field-day">network field day</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/network-forensics">network forensics</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/nfd23">nfd23</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/organization">organization</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/partitions">partitions</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/past">past</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/pcap">pcap</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/present">present</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/sans">sans</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/scapy">scapy</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/scripts">scripts</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/sharkfest">sharkfest</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/stream">stream</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/surface-pro">surface pro</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/suricata">suricata</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/t-i-w-a">t.i.w.a</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/tags">Tags</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/tcp">tcp</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/tcpdump">tcpdump</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/tracewrangler">tracewrangler</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/vyos">vyos</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/wireshark">wireshark</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/tag/zeek">zeek</a></li>--><li> <a target="_blank" href="https://blog.showipintbri.com/pages/showipintbri/blog-source/feed.xml">Subscribe via RSS</a></li></div><!--Blog-post Section--><div class="column has-text-white"><h3>Recent Posts</h3><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/sharkfest-2021">WiresharkFest 2021 (US)</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/suricata-vyos">Build Your Own IPS w/ Suricata Container on VyOS Router</a></li><li> <a href="https://blog.showipintbri.com/pages/showipintbri/blog-source/blog/sans-for572">SANS: FOR572 & Passing the GNFA!!!</a></li></div></div></div><div class="has-background-black has-text-centered has-text-white" id="credits"> <i class="far fa-copyright"></i> 2021 | Based on <a href="https://github.com/thedevslot/WhatATheme" target="_blank" rel="noopener noreferrer">WhatATheme</a> by <a href="https://www.twitter.com/thedevslot" target="_blank" rel="noopener noreferrer">TheDevsLot</a> Powered by <a href="https://jekyllrb.com/" target="_blank">Jekyll</a></div></footer></body></html>
